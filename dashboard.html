<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI管理ダッシュボード</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }
        
        .month-year-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .month-year-selector select {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
        }
        
        .tab-button {
            padding: 12px 28px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #64748b;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        
        .mode-button {
            padding: 12px 28px;
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #3b82f6;
        }
        
        .mode-button.edit-active {
            background: #fef2f2;
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .mode-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        
        .settings-button {
            padding: 12px 28px;
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #22c55e;
        }
        
        .settings-button:hover {
            background: #dcfce7;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
        }
        
        .edit-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fef2f2;
            border: 2px solid #fecaca;
            padding: 12px 24px;
            border-radius: 30px;
            display: none;
            z-index: 100;
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        
        .edit-indicator.show {
            display: block;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        .kpi-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }
        
        .kpi-content {
            display: grid;
            grid-template-columns: 1fr 200px 300px;
            gap: 30px;
            align-items: center;
        }
        
        .kpi-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .kpi-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .kpi-details {
            flex: 1;
        }
        
        .kpi-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .kpi-subtitle {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .kpi-metrics {
            display: flex;
            gap: 20px;
        }
        
        .metric-item {
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .metric-diff {
            font-size: 0.9rem;
            margin-top: 3px;
        }
        
        .metric-diff.positive {
            color: #22c55e;
        }
        
        .metric-diff.negative {
            color: #ef4444;
        }
        
        .progress-achievement {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .progress-container {
            position: relative;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 1s ease;
            border-radius: 10px;
        }
        
        .progress-fill.low {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .progress-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .achievement-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .achievement-rate {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .achievement-rate.high {
            color: #22c55e;
        }
        
        .achievement-rate.medium {
            color: #f59e0b;
        }
        
        .achievement-rate.low {
            color: #ef4444;
        }
        
        .conversion-rate {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .conversion-rate-label {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .conversion-rate-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        /* 週選択UI */
        .week-selector {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.06);
        }
        
        .week-selector.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .week-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .week-tab {
            padding: 10px 20px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: #64748b;
            font-weight: 500;
        }
        
        .week-tab.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .week-tab:hover:not(.active) {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .week-date-range {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 3px;
        }
        
        /* データ入力セクション */
        .data-input-section {
            display: none;
            margin-bottom: 30px;
        }
        
        .data-input-section.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .input-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.06);
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        .input-section h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
            font-size: 0.9rem;
        }
        
        .input-group input {
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            color: #1e293b;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .close-button {
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .close-button:hover {
            background: #f1f5f9;
            color: #1e293b;
        }
        
        .export-import-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .fab:hover {
            transform: scale(1.1);
        }
        
        .fab-export {
            background: #22c55e;
            color: white;
        }
        
        .fab-export:hover {
            background: #16a34a;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }
        
        .fab-import {
            background: #f59e0b;
            color: white;
        }
        
        .fab-import:hover {
            background: #d97706;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .kpi-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .modal-content {
                padding: 24px;
            }
            
            .export-import-controls {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="edit-indicator" id="edit-indicator">
            <span style="color: #ef4444; font-weight: 600;">📝 編集モード</span>
        </div>
        
        <div class="header">
            <h1>KPI ダッシュボード</h1>
            
            <div class="month-year-selector">
                <select id="year-selector" onchange="changeMonth()">
                    <!-- 年の選択肢はJavaScriptで生成 -->
                </select>
                <select id="month-selector" onchange="changeMonth()">
                    <option value="0">1月</option>
                    <option value="1">2月</option>
                    <option value="2">3月</option>
                    <option value="3">4月</option>
                    <option value="4">5月</option>
                    <option value="5">6月</option>
                    <option value="6">7月</option>
                    <option value="7">8月</option>
                    <option value="8">9月</option>
                    <option value="9">10月</option>
                    <option value="10">11月</option>
                    <option value="11">12月</option>
                </select>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <button class="tab-button active" onclick="switchView('monthly')">月間表示</button>
                    <button class="tab-button" onclick="switchView('weekly')">週間表示</button>
                </div>
                <button class="mode-button" id="mode-button" onclick="toggleMode()">編集モード</button>
                <button class="settings-button" onclick="toggleSettings()">設定</button>
            </div>
        </div>

        <!-- 週選択 -->
        <div class="week-selector" id="week-selector">
            <div class="week-tabs" id="week-tabs">
                <!-- 週のタブはJavaScriptで動的に生成 -->
            </div>
        </div>

        <!-- データ入力セクション -->
        <div class="data-input-section" id="data-input">
            <div class="input-container">
                <h2 style="color: #1e293b; margin-bottom: 30px;" id="input-title">データ入力</h2>
                
                <div class="input-section" id="goal-input-section" style="display: none;">
                    <h3>📊 月間目標設定</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>再生数 (月間目標)</label>
                            <input type="number" id="input-monthly-play-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>プロフ遷移数 (月間目標)</label>
                            <input type="number" id="input-monthly-profile-transition-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>LPクリック数 (月間目標)</label>
                            <input type="number" id="input-monthly-lp-click-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>LINE登録数 (月間目標)</label>
                            <input type="number" id="input-monthly-line-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>予約数 (月間目標)</label>
                            <input type="number" id="input-monthly-reservation-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>着席数 (月間目標)</label>
                            <input type="number" id="input-monthly-seated-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>有効数 (月間目標)</label>
                            <input type="number" id="input-monthly-valid-goal" placeholder="月間目標">
                        </div>
                        <div class="input-group">
                            <label>投稿数 (月間目標)</label>
                            <input type="number" id="input-monthly-posts-goal" placeholder="月間目標">
                        </div>
                    </div>
                </div>
                
                <div class="input-section" id="result-input-section">
                    <h3 id="result-input-title">✍️ 実績入力</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>再生数</label>
                            <input type="number" id="input-play-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>プロフ遷移数</label>
                            <input type="number" id="input-profile-transition-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>LPクリック数</label>
                            <input type="number" id="input-lp-click-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>LINE登録数</label>
                            <input type="number" id="input-line-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>予約数</label>
                            <input type="number" id="input-reservation-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>着席数</label>
                            <input type="number" id="input-seated-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>有効数</label>
                            <input type="number" id="input-valid-result" placeholder="結果">
                        </div>
                        <div class="input-group">
                            <label>投稿数</label>
                            <input type="number" id="input-posts-result" placeholder="結果">
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="clearInputs()">クリア</button>
                    <button class="btn btn-primary" onclick="saveData()">保存</button>
                </div>
            </div>
        </div>
        
        <!-- KPIカード（縦並び） -->
        <div class="kpi-container">
            <!-- 再生数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #f3f4f6;">📺</div>
                        <div class="kpi-details">
                            <div class="kpi-title">再生数</div>
                            <div class="kpi-subtitle">動画の総再生回数</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="play-goal">5,000</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="play-result">5,123</div>
                            <div class="metric-diff positive" id="play-diff">+123</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="play-progress" style="width: 102.5%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate high" id="play-achievement">102.5%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- プロフ遷移数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #fef3c7;">👤</div>
                        <div class="kpi-details">
                            <div class="kpi-title">プロフ遷移数</div>
                            <div class="kpi-subtitle">プロフィールページへの遷移</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="profile-transition-goal">600</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="profile-transition-result">567</div>
                            <div class="metric-diff negative" id="profile-transition-diff">-33</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="profile-transition-progress" style="width: 94.5%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="profile-transition-achievement">94.5%</span>
                            <div class="conversion-rate">
                                <span class="conversion-rate-label">再生からの遷移率:</span>
                                <span class="conversion-rate-value" id="profile-transition-conversion">11.1%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LPクリック数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #dbeafe;">🔗</div>
                        <div class="kpi-details">
                            <div class="kpi-title">LPクリック数</div>
                            <div class="kpi-subtitle">ランディングページへのクリック</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="lp-click-goal">2,500</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="lp-click-result">2,345</div>
                            <div class="metric-diff negative" id="lp-click-diff">-155</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="lp-click-progress" style="width: 93.8%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="lp-click-achievement">93.8%</span>
                            <div class="conversion-rate">
                                <span class="conversion-rate-label">プロフからのクリック率:</span>
                                <span class="conversion-rate-value" id="lp-click-conversion">413.6%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LINE登録数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #d1fae5;">💬</div>
                        <div class="kpi-details">
                            <div class="kpi-title">LINE登録数</div>
                            <div class="kpi-subtitle">LINE公式アカウントへの登録</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="line-goal">900</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="line-result">789</div>
                            <div class="metric-diff negative" id="line-diff">-111</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="line-progress" style="width: 87.7%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="line-achievement">87.7%</span>
                            <div class="conversion-rate">
                                <span class="conversion-rate-label">LPからの登録率:</span>
                                <span class="conversion-rate-value" id="line-conversion">33.6%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 予約数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #fed7aa;">📅</div>
                        <div class="kpi-details">
                            <div class="kpi-title">予約数</div>
                            <div class="kpi-subtitle">来店予約の総数</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="reservation-goal">500</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="reservation-result">456</div>
                            <div class="metric-diff negative" id="reservation-diff">-44</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="reservation-progress" style="width: 91.2%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="reservation-achievement">91.2%</span>
                            <div class="conversion-rate">
                                <span class="conversion-rate-label">LINE登録からの予約率:</span>
                                <span class="conversion-rate-value" id="reservation-conversion">57.8%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 着席数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #e0e7ff;">🪑</div>
                        <div class="kpi-details">
                            <div class="kpi-title">着席数</div>
                            <div class="kpi-subtitle">実際に来店された人数</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="seated-goal">1,000</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="seated-result">892</div>
                            <div class="metric-diff negative" id="seated-diff">-108</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="seated-progress" style="width: 89.2%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="seated-achievement">89.2%</span>
                            <div class="conversion-rate">
                                <span class="conversion-rate-label">予約からの着席率:</span>
                                <span class="conversion-rate-value" id="seated-conversion">195.6%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 有効数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #ccfbf1;">✅</div>
                        <div class="kpi-details">
                            <div class="kpi-title">有効数</div>
                            <div class="kpi-subtitle">成約・購入につながった数</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="valid-goal">1,500</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="valid-result">1,234</div>
                            <div class="metric-diff negative" id="valid-diff">-266</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="valid-progress" style="width: 82.3%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="valid-achievement">82.3%</span>
                            <div class="conversion-rate">
                                <span class="conversion-rate-label">着席からの有効率:</span>
                                <span class="conversion-rate-value" id="valid-conversion">138.3%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 投稿数 -->
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-info">
                        <div class="kpi-icon" style="background: #ede9fe;">📝</div>
                        <div class="kpi-details">
                            <div class="kpi-title">投稿数</div>
                            <div class="kpi-subtitle">SNS等への投稿総数</div>
                        </div>
                    </div>
                    
                    <div class="kpi-metrics">
                        <div class="metric-item">
                            <div class="metric-label">目標</div>
                            <div class="metric-value" id="posts-goal">50</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">結果</div>
                            <div class="metric-value" id="posts-result">42</div>
                            <div class="metric-diff negative" id="posts-diff">-8</div>
                        </div>
                    </div>
                    
                    <div class="progress-achievement">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill medium" id="posts-progress" style="width: 84%"></div>
                            </div>
                        </div>
                        <div class="achievement-info">
                            <span class="achievement-rate medium" id="posts-achievement">84.0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">設定</h2>
                <button class="close-button" onclick="closeModal()">×</button>
            </div>
            
            <div class="input-section">
                <h3>⚙️ 表示設定</h3>
                <div class="input-group">
                    <label>自動保存</label>
                    <select id="auto-save" style="padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; color: #1e293b; width: 100%;">
                        <option value="true">有効</option>
                        <option value="false">無効</option>
                    </select>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>データ保存期間</label>
                    <select id="data-retention" style="padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; color: #1e293b; width: 100%;">
                        <option value="30">30日</option>
                        <option value="60">60日</option>
                        <option value="90">90日</option>
                        <option value="365">1年</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="updateSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- エクスポート/インポートボタン -->
    <div class="export-import-controls">
        <button class="fab fab-import" onclick="importData()" title="インポート">📥</button>
        <button class="fab fab-export" onclick="exportData()" title="エクスポート">📤</button>
    </div>

    <input type="file" id="file-input" style="display: none;" accept=".json" onchange="handleFileImport(event)">

    <script>
        // データ構造
        let data = {};
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let currentView = 'monthly';
        let currentWeek = 1;
        let editMode = false;

        let settings = JSON.parse(localStorage.getItem('dashboardSettings')) || {
            autoSave: true,
            dataRetention: 30
        };

        // 初期化
        function initializeApp() {
            loadData();
            initializeYearSelector();
            updateMonthSelector();
            generateWeekTabs();
            updateDisplay();
            updateInputSection();
        }

        // データの読み込みと初期化
        function loadData() {
            const savedData = localStorage.getItem('dashboardData');
            if (savedData) {
                data = JSON.parse(savedData);
            }
            
            // 現在の年月のデータが存在しない場合は初期化
            const yearKey = currentYear.toString();
            const monthKey = currentMonth.toString();
            
            if (!data[yearKey]) {
                data[yearKey] = {};
            }
            
            if (!data[yearKey][monthKey]) {
                data[yearKey][monthKey] = {
                    monthly: {
                        play: { goal: 0, result: 0 },
                        profileTransition: { goal: 0, result: 0 },
                        lpClick: { goal: 0, result: 0 },
                        line: { goal: 0, result: 0 },
                        reservation: { goal: 0, result: 0 },
                        seated: { goal: 0, result: 0 },
                        valid: { goal: 0, result: 0 },
                        posts: { goal: 0, result: 0 }
                    },
                    weekly: {}
                };
                
                // 週のデータを初期化
                for (let i = 1; i <= 5; i++) {
                    data[yearKey][monthKey].weekly[`week${i}`] = {
                        play: { result: 0 },
                        profileTransition: { result: 0 },
                        lpClick: { result: 0 },
                        line: { result: 0 },
                        reservation: { result: 0 },
                        seated: { result: 0 },
                        valid: { result: 0 },
                        posts: { result: 0 }
                    };
                }
            }
        }

        // 年選択の初期化
        function initializeYearSelector() {
            const yearSelector = document.getElementById('year-selector');
            const currentYear = new Date().getFullYear();
            
            for (let year = 2025; year <= 2028; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}年`;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelector.appendChild(option);
            }
        }

        // 月選択の更新
        function updateMonthSelector() {
            const monthSelector = document.getElementById('month-selector');
            monthSelector.value = currentMonth;
        }

        // 月の変更
        function changeMonth() {
            currentYear = parseInt(document.getElementById('year-selector').value);
            currentMonth = parseInt(document.getElementById('month-selector').value);
            
            loadData();
            generateWeekTabs();
            updateDisplay();
            loadInputData();
        }

        // 週タブの生成
        function generateWeekTabs() {
            const weekTabsContainer = document.getElementById('week-tabs');
            weekTabsContainer.innerHTML = '';
            
            const year = currentYear;
            const month = currentMonth;
            
            // 月の最初の日と最後の日を取得
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // 最初の月曜日を探す
            let currentDate = new Date(firstDay);
            const firstDayOfWeek = firstDay.getDay();
            
            // 月の1日が月曜日でない場合、その週は第1週として扱う（1日だけでも）
            if (firstDayOfWeek !== 1) {
                // 第1週の終了日を計算（次の日曜日まで）
                const daysUntilSunday = firstDayOfWeek === 0 ? 0 : 7 - firstDayOfWeek;
                const firstWeekEnd = new Date(year, month, 1 + daysUntilSunday);
                
                // 第1週のタブを作成
                const weekTab = document.createElement('div');
                weekTab.className = currentWeek === 1 ? 'week-tab active' : 'week-tab';
                weekTab.onclick = () => selectWeek(1);
                
                const weekLabel = document.createElement('div');
                weekLabel.textContent = '第1週';
                
                const dateRange = document.createElement('div');
                dateRange.className = 'week-date-range';
                dateRange.textContent = `${month + 1}/1 - ${month + 1}/${firstWeekEnd.getDate()}`;
                
                weekTab.appendChild(weekLabel);
                weekTab.appendChild(dateRange);
                weekTabsContainer.appendChild(weekTab);
                
                // 次の週の開始日（翌月曜日）を設定
                currentDate = new Date(year, month, 1 + daysUntilSunday + 1);
            }
            
            // 残りの週を生成
            for (let week = firstDayOfWeek === 1 ? 1 : 2; week <= 5; week++) {
                if (currentDate > lastDay) break;
                
                const weekTab = document.createElement('div');
                weekTab.className = week === currentWeek ? 'week-tab active' : 'week-tab';
                weekTab.onclick = () => selectWeek(week);
                
                const weekStart = new Date(currentDate);
                let weekEnd = new Date(currentDate);
                
                if (week === 5) {
                    // 第5週は月末まで
                    weekEnd = new Date(lastDay);
                } else {
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    // 月末を超えないように調整
                    if (weekEnd > lastDay) {
                        weekEnd = new Date(lastDay);
                    }
                }
                
                const weekLabel = document.createElement('div');
                weekLabel.textContent = `第${week}週`;
                
                const dateRange = document.createElement('div');
                dateRange.className = 'week-date-range';
                dateRange.textContent = `${month + 1}/${weekStart.getDate()} - ${month + 1}/${weekEnd.getDate()}`;
                
                weekTab.appendChild(weekLabel);
                weekTab.appendChild(dateRange);
                weekTabsContainer.appendChild(weekTab);
                
                // 次の週の開始日を設定
                currentDate.setDate(currentDate.getDate() + 7);
            }
        }

        // ビューの切り替え
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 週選択UIの表示/非表示
            const weekSelector = document.getElementById('week-selector');
            if (view === 'weekly' && editMode) {
                weekSelector.classList.add('show');
            } else {
                weekSelector.classList.remove('show');
            }
            
            updateInputSection();
            updateDisplay();
            loadInputData();
        }

        // 週の選択
        function selectWeek(week) {
            currentWeek = week;
            document.querySelectorAll('.week-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            updateInputSection();
            loadInputData();
        }

        // 入力セクションの更新
        function updateInputSection() {
            const goalSection = document.getElementById('goal-input-section');
            const resultSection = document.getElementById('result-input-section');
            const inputTitle = document.getElementById('input-title');
            const resultInputTitle = document.getElementById('result-input-title');
            
            if (currentView === 'monthly') {
                goalSection.style.display = 'block';
                resultSection.style.display = 'none';
                inputTitle.textContent = `${currentYear}年${currentMonth + 1}月 月間目標入力`;
            } else {
                goalSection.style.display = 'none';
                resultSection.style.display = 'block';
                inputTitle.textContent = `${currentYear}年${currentMonth + 1}月 第${currentWeek}週 実績入力`;
                resultInputTitle.textContent = `✍️ 第${currentWeek}週実績入力`;
            }
        }

        // 編集モードの切り替え
        function toggleMode() {
            editMode = !editMode;
            const dataInput = document.getElementById('data-input');
            const modeBtn = document.getElementById('mode-button');
            const editIndicator = document.getElementById('edit-indicator');
            const weekSelector = document.getElementById('week-selector');
            
            if (editMode) {
                dataInput.classList.add('show');
                modeBtn.classList.add('edit-active');
                modeBtn.textContent = '表示モード';
                editIndicator.classList.add('show');
                
                if (currentView === 'weekly') {
                    weekSelector.classList.add('show');
                }
                
                loadInputData();
            } else {
                dataInput.classList.remove('show');
                modeBtn.classList.remove('edit-active');
                modeBtn.textContent = '編集モード';
                editIndicator.classList.remove('show');
                weekSelector.classList.remove('show');
            }
            
            updateInputSection();
        }

        // 設定画面の表示
        function toggleSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('auto-save').value = settings.autoSave.toString();
            document.getElementById('data-retention').value = settings.dataRetention.toString();
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // 設定の更新
        function updateSettings() {
            settings.autoSave = document.getElementById('auto-save').value === 'true';
            settings.dataRetention = parseInt(document.getElementById('data-retention').value);
            localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            closeModal();
        }

        // 達成率の計算
        function calculateAchievementRate(goal, result) {
            if (goal === 0) return 0;
            return ((result / goal) * 100).toFixed(1);
        }

        // プログレスバーのクラスを取得
        function getProgressClass(rate) {
            const numRate = parseFloat(rate);
            if (numRate >= 100) return '';
            if (numRate >= 80) return 'medium';
            return 'low';
        }

        // 達成率のクラスを取得
        function getRateClass(rate) {
            const numRate = parseFloat(rate);
            if (numRate >= 100) return 'high';
            if (numRate >= 80) return 'medium';
            return 'low';
        }

        // 差分のフォーマット
        function formatDiff(goal, result) {
            const diff = result - goal;
            return diff >= 0 ? `+${diff.toLocaleString()}` : diff.toLocaleString();
        }

        // 月間結果の計算
        function calculateMonthlyResult() {
            const yearKey = currentYear.toString();
            const monthKey = currentMonth.toString();
            const monthData = data[yearKey][monthKey];
            
            if (!monthData) return;
            
            const metrics = ['play', 'profileTransition', 'lpClick', 'line', 'reservation', 'seated', 'valid', 'posts'];
            
            metrics.forEach(metric => {
                let total = 0;
                for (let i = 1; i <= 5; i++) {
                    total += monthData.weekly[`week${i}`][metric].result || 0;
                }
                monthData.monthly[metric].result = total;
            });
        }

        // 表示の更新
        function updateDisplay() {
            const yearKey = currentYear.toString();
            const monthKey = currentMonth.toString();
            const monthData = data[yearKey][monthKey];
            
            if (!monthData) return;
            
            let displayData;
            
            if (currentView === 'monthly') {
                calculateMonthlyResult();
                displayData = monthData.monthly;
            } else {
                // 週間表示の場合、週のデータと月間目標を週数で割った値を使用
                displayData = {};
                const metrics = ['play', 'profileTransition', 'lpClick', 'line', 'reservation', 'seated', 'valid', 'posts'];
                
                metrics.forEach(metric => {
                    displayData[metric] = {
                        goal: Math.round(monthData.monthly[metric].goal / 5), // 5週で割る
                        result: monthData.weekly[`week${currentWeek}`][metric].result || 0
                    };
                });
            }
            
            // 各指標を更新
            const metrics = ['play', 'profileTransition', 'lpClick', 'line', 'reservation', 'seated', 'valid', 'posts'];
            
            metrics.forEach(metric => {
                const metricData = displayData[metric];
                const goal = metricData.goal;
                const result = metricData.result;
                const achievement = calculateAchievementRate(goal, result);
                
                const goalElement = document.getElementById(`${metric.replace(/([A-Z])/g, '-$1').toLowerCase()}-goal`);
                const resultElement = document.getElementById(`${metric.replace(/([A-Z])/g, '-$1').toLowerCase()}-result`);
                const diffElement = document.getElementById(`${metric.replace(/([A-Z])/g, '-$1').toLowerCase()}-diff`);
                const progressElement = document.getElementById(`${metric.replace(/([A-Z])/g, '-$1').toLowerCase()}-progress`);
                const achievementElement = document.getElementById(`${metric.replace(/([A-Z])/g, '-$1').toLowerCase()}-achievement`);
                
                if (goalElement) {
                    goalElement.textContent = goal.toLocaleString();
                }
                if (resultElement) {
                    resultElement.textContent = result.toLocaleString();
                }
                if (diffElement) {
                    const diff = result - goal;
                    diffElement.textContent = formatDiff(goal, result);
                    diffElement.className = diff >= 0 ? 'metric-diff positive' : 'metric-diff negative';
                }
                if (progressElement) {
                    progressElement.style.width = Math.min(parseFloat(achievement), 100) + '%';
                    progressElement.className = 'progress-fill ' + getProgressClass(achievement);
                }
                if (achievementElement) {
                    achievementElement.textContent = achievement + '%';
                    achievementElement.className = 'achievement-rate ' + getRateClass(achievement);
                }
            });
            
            // コンバージョン率を計算
            updateConversionRates(displayData);
        }

        // コンバージョン率の更新
        function updateConversionRates(viewData) {
            // プロフ遷移率
            const profileTransitionRate = viewData.play.result > 0 ? 
                ((viewData.profileTransition.result / viewData.play.result) * 100).toFixed(1) : 0;
            document.getElementById('profile-transition-conversion').textContent = profileTransitionRate + '%';
            
            // LPクリック率
            const lpClickRate = viewData.profileTransition.result > 0 ? 
                ((viewData.lpClick.result / viewData.profileTransition.result) * 100).toFixed(1) : 0;
            document.getElementById('lp-click-conversion').textContent = lpClickRate + '%';
            
            // LINE登録率
            const lineRate = viewData.lpClick.result > 0 ? 
                ((viewData.line.result / viewData.lpClick.result) * 100).toFixed(1) : 0;
            document.getElementById('line-conversion').textContent = lineRate + '%';
            
            // 予約率
            const reservationRate = viewData.line.result > 0 ? 
                ((viewData.reservation.result / viewData.line.result) * 100).toFixed(1) : 0;
            document.getElementById('reservation-conversion').textContent = reservationRate + '%';
            
            // 着席率
            const seatedRate = viewData.reservation.result > 0 ? 
                ((viewData.seated.result / viewData.reservation.result) * 100).toFixed(1) : 0;
            document.getElementById('seated-conversion').textContent = seatedRate + '%';
            
            // 有効率
            const validRate = viewData.seated.result > 0 ? 
                ((viewData.valid.result / viewData.seated.result) * 100).toFixed(1) : 0;
            document.getElementById('valid-conversion').textContent = validRate + '%';
        }

        // 入力データの読み込み
        function loadInputData() {
            const yearKey = currentYear.toString();
            const monthKey = currentMonth.toString();
            const monthData = data[yearKey][monthKey];
            
            if (!monthData) return;
            
            if (currentView === 'monthly') {
                // 月間目標を読み込み
                document.getElementById('input-monthly-play-goal').value = monthData.monthly.play.goal || '';
                document.getElementById('input-monthly-profile-transition-goal').value = monthData.monthly.profileTransition.goal || '';
                document.getElementById('input-monthly-lp-click-goal').value = monthData.monthly.lpClick.goal || '';
                document.getElementById('input-monthly-line-goal').value = monthData.monthly.line.goal || '';
                document.getElementById('input-monthly-reservation-goal').value = monthData.monthly.reservation.goal || '';
                document.getElementById('input-monthly-seated-goal').value = monthData.monthly.seated.goal || '';
                document.getElementById('input-monthly-valid-goal').value = monthData.monthly.valid.goal || '';
                document.getElementById('input-monthly-posts-goal').value = monthData.monthly.posts.goal || '';
                
                // 月間表示では実績入力フィールドは表示しない
            } else {
                // 週間実績を読み込み
                const weekData = monthData.weekly[`week${currentWeek}`];
                document.getElementById('input-play-result').value = weekData.play.result || '';
                document.getElementById('input-profile-transition-result').value = weekData.profileTransition.result || '';
                document.getElementById('input-lp-click-result').value = weekData.lpClick.result || '';
                document.getElementById('input-line-result').value = weekData.line.result || '';
                document.getElementById('input-reservation-result').value = weekData.reservation.result || '';
                document.getElementById('input-seated-result').value = weekData.seated.result || '';
                document.getElementById('input-valid-result').value = weekData.valid.result || '';
                document.getElementById('input-posts-result').value = weekData.posts.result || '';
            }
        }

        // 入力フィールドのクリア
        function clearInputs() {
            document.querySelectorAll('#data-input input').forEach(input => {
                input.value = '';
            });
        }

        // データの保存
        function saveData() {
            const yearKey = currentYear.toString();
            const monthKey = currentMonth.toString();
            const monthData = data[yearKey][monthKey];
            
            if (currentView === 'monthly') {
                // 月間目標を保存
                monthData.monthly.play.goal = parseInt(document.getElementById('input-monthly-play-goal').value) || 0;
                monthData.monthly.profileTransition.goal = parseInt(document.getElementById('input-monthly-profile-transition-goal').value) || 0;
                monthData.monthly.lpClick.goal = parseInt(document.getElementById('input-monthly-lp-click-goal').value) || 0;
                monthData.monthly.line.goal = parseInt(document.getElementById('input-monthly-line-goal').value) || 0;
                monthData.monthly.reservation.goal = parseInt(document.getElementById('input-monthly-reservation-goal').value) || 0;
                monthData.monthly.seated.goal = parseInt(document.getElementById('input-monthly-seated-goal').value) || 0;
                monthData.monthly.valid.goal = parseInt(document.getElementById('input-monthly-valid-goal').value) || 0;
                monthData.monthly.posts.goal = parseInt(document.getElementById('input-monthly-posts-goal').value) || 0;
                
                // 月間結果を再計算
                calculateMonthlyResult();
            } else {
                // 週間実績を保存
                const weekData = monthData.weekly[`week${currentWeek}`];
                weekData.play.result = parseInt(document.getElementById('input-play-result').value) || 0;
                weekData.profileTransition.result = parseInt(document.getElementById('input-profile-transition-result').value) || 0;
                weekData.lpClick.result = parseInt(document.getElementById('input-lp-click-result').value) || 0;
                weekData.line.result = parseInt(document.getElementById('input-line-result').value) || 0;
                weekData.reservation.result = parseInt(document.getElementById('input-reservation-result').value) || 0;
                weekData.seated.result = parseInt(document.getElementById('input-seated-result').value) || 0;
                weekData.valid.result = parseInt(document.getElementById('input-valid-result').value) || 0;
                weekData.posts.result = parseInt(document.getElementById('input-posts-result').value) || 0;
            }
            
            localStorage.setItem('dashboardData', JSON.stringify(data));
            updateDisplay();
        }

        // データのエクスポート
        function exportData() {
            const exportObj = {
                data: data,
                settings: settings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `dashboard_data_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        }

        // データのインポート
        function importData() {
            document.getElementById('file-input').click();
        }

        // ファイルインポートの処理
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.data) {
                            data = importedData.data;
                            localStorage.setItem('dashboardData', JSON.stringify(data));
                        }
                        if (importedData.settings) {
                            settings = importedData.settings;
                            localStorage.setItem('dashboardSettings', JSON.stringify(settings));
                        }
                        updateDisplay();
                        loadInputData();
                    } catch (error) {
                        alert('ファイルの読み込みに失敗しました。');
                    }
                };
                reader.readAsText(file);
            }
        }

        // モーダル外クリックで閉じる
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // 自動保存
        setInterval(() => {
            if (settings.autoSave && editMode) {
                saveData();
            }
        }, 30000); // 30秒ごと

        // アプリケーションの初期化
        initializeApp();
        
        // 親ウィンドウからのメッセージを受信（viewer.html用）
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateData') {
                data = event.data.data;
                localStorage.setItem('dashboardData', JSON.stringify(data));
                updateDisplay();
                loadInputData();
            }
        });
    </script>
</body>
</html>